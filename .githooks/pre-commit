#!/bin/sh
set -eu

echo "Running pre-commit checks..."

# Check for staged Go files (excluding generated files)
GO_FILES=$(git diff --cached --name-only --diff-filter=ACMR | \
    grep '\.go$' | \
    grep -v '_gen\.go$' | \
    grep -v '\.pb\.go$' || true)

if [ -z "$GO_FILES" ]; then
    echo "No Go files in this commit, skipping checks"
    exit 0
fi

echo "Go files detected in commit:"
echo "$GO_FILES" | sed 's/^/  /'

# Check if required tools are available
if ! command -v gofmt >/dev/null 2>&1; then
    echo "ERROR: gofmt not found in PATH"
    exit 1
fi

if ! command -v golangci-lint >/dev/null 2>&1; then
    echo "ERROR: golangci-lint not found in PATH"
    echo "Install: curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b \$(go env GOPATH)/bin"
    exit 1
fi

# Track if we made any fixes
FIXED=0

# Step 1: Auto-format with gofmt
echo ""
echo "Checking formatting..."
UNFORMATTED=$(echo "$GO_FILES" | xargs gofmt -l 2>/dev/null || true)

if [ -n "$UNFORMATTED" ]; then
    echo "Auto-formatting files:"
    echo "$UNFORMATTED" | sed 's/^/  /'
    echo "$UNFORMATTED" | xargs gofmt -w
    FIXED=1
fi

# Step 2: Auto-fix with golangci-lint
echo ""
echo "Running golangci-lint --fix..."
if golangci-lint run --fix ./... 2>/dev/null; then
    : # Success, continue
else
    # --fix may return non-zero if there are unfixable issues
    # We'll catch those in the final check
    :
fi

# Step 3: Re-stage any modified files
if [ $FIXED -eq 1 ]; then
    echo ""
    echo "Re-staging formatted files..."
    echo "$GO_FILES" | xargs git add
fi

# Check if any staged files were modified by the fixes
MODIFIED_STAGED=$(git diff --name-only -- $GO_FILES 2>/dev/null || true)
if [ -n "$MODIFIED_STAGED" ]; then
    echo ""
    echo "Re-staging auto-fixed files:"
    echo "$MODIFIED_STAGED" | sed 's/^/  /'
    echo "$MODIFIED_STAGED" | xargs git add
fi

# Step 4: Final lint check (catch any remaining issues that can't be auto-fixed)
echo ""
echo "Running final lint check..."
if ! golangci-lint run ./...; then
    echo ""
    echo "ERROR: golangci-lint found issues that cannot be auto-fixed"
    echo "Please fix the issues above before committing"
    exit 1
fi

echo ""
echo "All pre-commit checks passed!"
